Эта задача была реализована с помощью трёхмерного дерева Фенвика, в котором также присутсвует метод высчитывающий ответ на запросы по формуле включений и исключений